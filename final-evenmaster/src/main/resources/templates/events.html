<!DOCTYPE html>
<html lang="az" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EventMaster — Tədbirlər Kataloqu</title>
    <link rel="stylesheet" href="/front/styles.css" />
    <style>
        .event-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        @media (max-width: 900px) { .event-list { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 620px) { .event-list { grid-template-columns: 1fr; } }
        .event { background: var(--card, #12141a); border: 1px solid var(--border, #22252e); border-radius: 14px; overflow: hidden; display: flex; flex-direction: column; }
        .event .event-media { position: relative; }
        .event .event-media img { width: 100%; height: 180px; object-fit: cover; display: block; }
        .event .event-media .badge { position: absolute; left: 10px; top: 10px; background: rgba(0,0,0,0.6); border: 1px solid var(--border, #22252e); padding: 4px 8px; border-radius: 999px; font-size: 12px; }
        .event .event-body { padding: 14px; display: grid; gap: 6px; }
        .event .event-meta { display: flex; align-items: center; justify-content: space-between; }
        .event .price { font-weight: 600; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
<header class="site-header">
    <div class="container">
        <a class="brand" href="/" aria-label="EventMaster ana səhifə">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M4 7h16M7 4v6m10-6v6M4 11h16v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>EventMaster</span>
        </a>
        <nav class="nav">
            <a href="/events" aria-current="page">Tədbirlər</a>
            <a href="/login">Giriş</a>
            <a class="btn ghost" href="/register">Qeydiyyat</a>
        </nav>
    </div>
</header>

<main>
    <section class="events" style="padding-top: 24px;">
        <div class="container">
            <h1 style="margin: 0 0 12px;">Bütün tədbirlər</h1>
            <p class="lead" style="margin: 0 0 16px;">Axtarın, filtrləyin və maraqlı tədbirləri kəşf edin.</p>

            <form id="filter-form" class="filters">
                <div class="filters-row">
                    <input type="text" id="q" placeholder="Ada görə axtar" />
                    <input type="text" id="location" placeholder="Məkana görə" />
                    <input type="date" id="fromDate" />
                    <input type="date" id="toDate" />
                    <select id="sort">
                        <option value="dateLine">Tarix</option>
                        <option value="priceStandard">Qiymət</option>
                    </select>
                    <select id="direction">
                        <option value="asc">Artan</option>
                        <option value="desc">Azalan</option>
                    </select>
                </div>
            </form>

            <div id="resultsCount" style="color: var(--muted); margin: 8px 0 16px;"></div>

            <div class="event-list" id="eventList">
                <div th:if="${events != null and !#lists.isEmpty(events)}">
                    <article class="event" th:each="ev : ${events}">
                        <a th:href="@{/events/event(id=${ev.id})}" style="text-decoration:none; color:inherit; display:block;" th:attr="data-event-id=${ev.id}">
                            <div class="event-media">
                                <img th:src="${ev.image != null ? ev.image : '/front/placeholder.jpg'}" th:alt="${ev.title != null ? ev.title : '—'}" loading="lazy" />
                                <span class="badge" th:text="${ev.dateLine != null ? #temporals.format(ev.dateLine, 'dd.MM.yyyy') : ''}"></span>
                            </div>
                            <div class="event-body">
                                <h4 th:text="${ev.title != null ? ev.title : ev.name}">Title</h4>
                                <p th:text="${ev.location != null ? ev.location : '—'}">Location</p>
                                <div class="event-meta">
                                    <span class="price" th:text="${ev.priceStandard != null and ev.priceStandard > 0 ? ev.priceStandard + ' AZN' : 'Pulsuz'}">Price</span>
                                    <a class="btn small" th:href="@{/events/event(id=${ev.id})}">Daha çox</a>
                                </div>
                            </div>
                        </a>
                    </article>
                </div>
                <p th:if="${events == null or #lists.isEmpty(events)}" style="color:var(--muted);">Heç bir nəticə tapılmadı.</p>
            </div>
        </div>
    </section>
</main>

<footer class="site-footer">
    <div class="container footer-inner">
        <p>© <span id="year"></span> EventMaster.</p>
        <nav class="footer-nav">
            <a href="/#contact">Əlaqə</a>
        </nav>
    </div>
</footer>

<script>
    function parseBadgeDate(text){
      // Supports dd.MM.yyyy and locale dates
      const t = (text || '').trim();
      const m = t.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
      if (m) {
        const [_, dd, mm, yyyy] = m;
        return new Date(Number(yyyy), Number(mm) - 1, Number(dd));
      }
      const d = new Date(t);
      return isNaN(d.getTime()) ? null : d;
    }

    function parsePrice(text){
    const raw = (text || '').toLowerCase().replace(/[₼azn]/g, '');
      if (raw.includes('pulsuz')) return 0;
      const t = raw.replace(/\s|\u00A0|\u202F/g, ' ');
      const m = t.match(/([0-9]{1,3}(?:[\s\u00A0\u202F.,][0-9]{3})+|[0-9]+)(?:([.,])([0-9]+))?/);
      if (!m) return Number.POSITIVE_INFINITY;
      const intPart = m[1].replace(/[\s\u00A0\u202F.,]/g, '');
      const fracPart = m[3] ? m[3] : '';
      const numStr = fracPart ? intPart + '.' + fracPart : intPart;
      const n = Number(numStr);
      return Number.isFinite(n) ? n : Number.POSITIVE_INFINITY;
    }

    const els = {
      container: document.querySelector('.event-list'),
      q: document.getElementById('q'),
      location: document.getElementById('location'),
      fromDate: document.getElementById('fromDate'),
      toDate: document.getElementById('toDate'),
      sort: document.getElementById('sort'),
      direction: document.getElementById('direction'),
      resultsCount: document.getElementById('resultsCount')
    };

    function snapshotItems(){
      const nodes = Array.from(els.container.querySelectorAll('article.event'));
      return nodes.map(node => {
        const title = (node.querySelector('h4')?.textContent || node.querySelector('h3')?.textContent || '').trim();
        const loc = (node.querySelector('.event-body p')?.textContent || '').trim();
        const dateText = (node.querySelector('.badge')?.textContent || '').trim();
        const priceText = (node.querySelector('.price')?.textContent || '').trim();
        const date = parseBadgeDate(dateText);
        const price = parsePrice(priceText);
        return { node, title, loc, date, price };
      });
    }

    const initialItems = snapshotItems();

    function applyFilters(){
      if (!els.container) return;
      const q = (els.q?.value || '').toLowerCase().trim();
      const lq = (els.location?.value || '').toLowerCase().trim();
      const from = els.fromDate?.value ? new Date(els.fromDate.value) : null;
      const to = els.toDate?.value ? new Date(els.toDate.value) : null;
      const sortKey = els.sort?.value || 'dateLine';
      const dir = (els.direction?.value || 'asc').toLowerCase();

      let items = initialItems.filter(item => {
        const matchesQ = !q || item.title.toLowerCase().includes(q);
        const matchesLoc = !lq || item.loc.toLowerCase().includes(lq);
        const matchesFrom = !from || (item.date && item.date >= from);
        const matchesTo = !to || (item.date && item.date <= to);
        return matchesQ && matchesLoc && matchesFrom && matchesTo;
      });

      items.sort((a, b) => {
        if (sortKey === 'priceStandard') {
          const av = Number.isFinite(a.price) ? a.price : Number.POSITIVE_INFINITY;
          const bv = Number.isFinite(b.price) ? b.price : Number.POSITIVE_INFINITY;
          if (!Number.isFinite(a.price) && Number.isFinite(b.price)) return 1; // a to end
          if (Number.isFinite(a.price) && !Number.isFinite(b.price)) return -1; // b to end
          if (av === bv) return 0;
          return dir === 'desc' ? (bv - av) : (av - bv);
        }
        // default dateLine
        const at = a.date ? a.date.getTime() : Number.POSITIVE_INFINITY;
        const bt = b.date ? b.date.getTime() : Number.POSITIVE_INFINITY;
        if (at === bt) return 0;
        return dir === 'desc' ? (bt - at) : (at - bt);
      });

      // Clear and append in new order
      els.container.innerHTML = '';
      if (items.length === 0) {
        els.container.innerHTML = '<p style="color: var(--muted); margin: 0;">Heç bir nəticə tapılmadı.</p>';
        if (els.resultsCount) els.resultsCount.textContent = '0 nəticə';
        return;
      }
      const frag = document.createDocumentFragment();
      items.forEach(i => frag.appendChild(i.node));
      els.container.appendChild(frag);
      if (els.resultsCount) els.resultsCount.textContent = items.length + ' nəticə';
    }

    ['input','change'].forEach(evt => {
      document.getElementById('filter-form').addEventListener(evt, applyFilters, { passive: true });
    });

    document.getElementById('year').textContent = new Date().getFullYear();
    applyFilters();
</script>
</body>
</html>


